
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>precio del dolar actualizado</title>
    <!-- Font Awesome 6 -->
     <link rel="icon" type="image/png" href="image/logoapk-convertido-a-512x512.PNG">

     <link rel="stylesheet" href="estilo.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google Fonts Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,400;14..32,500;14..32,600;14..32,700&display=swap" rel="stylesheet">
    
</head>
<body>
    <div class="glass-card">
        <div class="badge-venezuela">
            <span><i class="fas fa-map-pin"></i> Caracas · BCV</span>
        </div>

        <div class="title-section">
            <h1>tasa oficial<br>dólar today</h1>
            <div class="small-note"><i class="fas fa-database" style="margin-right: 4px;"></i> API viva</div>
        </div>

        <div class="tasa-en-vivo">
            <div class="label-live">
                <i class="fas fa-circle"></i> EN VIVO · BCV
                <!-- Indicador de actualización automática -->
                <span style="margin-left: auto; font-size: 0.7rem; background: #1f4172; padding: 0.2rem 0.7rem; border-radius: 30px;">
                    <i class="fas fa-sync-alt" id="autoRefreshIcon"></i> <span id="timerDisplay">30s</span>
                </span>
            </div>
            <div class="dolar-principal">
                <span class="simbolo">USD</span>
                <span id="dolarValor" class="valor-grande">-- <small>Bs</small></span>
            </div>
            <div class="fecha-actual" id="dolarFechaContainer">
                <i class="far fa-calendar-alt"></i>
                <span id="dolarFecha">actualizando...</span>
            </div>
            
            <!-- Barra de estado automático -->
            <div class="auto-refresh-indicator">
                <span><i class="fas fa-robot"></i> Actualización automática</span>
                <span class="timer-badge" id="countdownTimer">30 seg</span>
            </div>

            <button class="boton-actualizar" id="refreshBtn" onclick="actualizarDolarManual()">
                <i class="fas fa-sync-alt"></i> actualizar ahora
            </button>
        </div>

        <!-- CALCULADORA con formato venezolano  -->
        <div class="calculadora-section">
            <div class="calculadora-header">
                <i class="fas fa-calculator"></i> conversor inteligente
                <span style="flex:1; text-align:right; font-size:0.8rem; opacity:0.7;">formato VE</span>
            </div>

            <div class="conv-input-group">
                <div class="input-wrapper">
                    <i class="fas fa-dollar-sign"></i>
                    <input type="text" id="inputUSD" value="1,00" placeholder="0,00">
                </div>
                <div class="currency-symbol">USD</div>
            </div>

            <div style="display: flex; justify-content: center; margin: -5px 0 -5px;">
                <i class="fas fa-arrow-down swap-icon" style="background: #0f1e33; padding: 0.5rem; border-radius: 50%;"></i>
            </div>

            <div class="conv-input-group" style="margin-top: 0;">
                <div class="input-wrapper">
                    <i class="fas fa-bolt" style="color: #f9d77e;"></i>
                    <input type="text" id="outputBs" readonly value="0,00" placeholder="0,00" style="background:#071527; border-color:#3e6190;">
                </div>
                <div class="currency-symbol">Bs</div>
            </div>

            <div class="resultado-bs">
                <span><i class="fas fa-coins" style="color: gold;"></i> cambio actual</span>
                <span class="monto-final" id="cambioEjemplo">0,00 <small>Bs</small></span>
            </div>

            <div class="footnote">
                <span><i class="far fa-clock"></i> auto cada 30s</span>
                <a href="#" onclick="actualizarDolarManual();return false;"><i class="fas fa-redo-alt"></i> sincronizar</a>
            </div>
        </div>

        <div style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: center; font-size: 0.75rem; color: #416493;">
            <span><i class="fas fa-shield-alt"></i> datos: en tienpo real</span>
            <span><i class="fas fa-bank"></i> BCV oficial</span>
        </div>
    </div>

    <script>
        // ---- Utilidades de formato venezolano ----
        function formatearVENumero(valor) {
            if (valor === null || isNaN(valor)) return '0,00';
            let partes = valor.toFixed(2).split('.');
            let enteros = partes[0].replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            return enteros + ',' + partes[1];
        }

        function parseVENumber(str) {
            if (!str) return 0;
            let limpio = str.replace(/\./g, '').replace(',', '.');
            let num = parseFloat(limpio);
            return isNaN(num) ? 0 : num;
        }

        // ---- Estado global ----
        let tasaOficial = null;
        let autoRefreshInterval = null;
        let countdownSeconds = 30;
        let countdownInterval = null;

        // Elementos DOM
        const dolarValorEl = document.getElementById('dolarValor');
        const dolarFechaEl = document.getElementById('dolarFecha');
        const inputUSD = document.getElementById('inputUSD');
        const outputBs = document.getElementById('outputBs');
        const cambioEjemplo = document.getElementById('cambioEjemplo');
        const timerDisplay = document.getElementById('timerDisplay');
        const countdownTimer = document.getElementById('countdownTimer');
        const autoRefreshIcon = document.getElementById('autoRefreshIcon');

        // ---- Funciones de calculadora ----
        function actualizarCamposCalculadora() {
            if (tasaOficial === null || isNaN(tasaOficial) || tasaOficial <= 0) {
                outputBs.value = '0,00';
                if (cambioEjemplo) cambioEjemplo.innerText = '0,00 Bs';
                return;
            }

            let usdValue = parseVENumber(inputUSD.value);
            if (usdValue < 0) usdValue = 0;

            const bsResult = usdValue * tasaOficial;
            outputBs.value = formatearVENumero(bsResult);
            if (cambioEjemplo) {
                cambioEjemplo.innerText = formatearVENumero(bsResult) + ' Bs';
            }
        }

        inputUSD.addEventListener('input', actualizarCamposCalculadora);
        inputUSD.addEventListener('blur', function() {
            let valorNumerico = parseVENumber(inputUSD.value);
            if (isNaN(valorNumerico) || valorNumerico < 0) valorNumerico = 0;
            inputUSD.value = formatearVENumero(valorNumerico);
            actualizarCamposCalculadora();
        });

        // ---- Función principal de actualización ----
        function obtenerDolar(mostrarMensaje = false) {
            // Cambiar ícono para indicar carga
            if (autoRefreshIcon) autoRefreshIcon.className = 'fas fa-sync-alt fa-spin';
            
            fetch("https://ve.dolarapi.com/v1/dolares/oficial")
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error ${response.status}`);
                return response.json();
            })
            .then(data => {
                let tasa = null;
                if (data && typeof data === 'object') {
                    if (data.promedio && !isNaN(data.promedio)) tasa = data.promedio;
                    else if (data.venta && !isNaN(data.venta)) tasa = data.venta;
                    else if (data.precio && !isNaN(data.precio)) tasa = data.precio;
                }

                if (tasa === null || tasa <= 0) throw new Error('No se pudo leer la tasa');

                // Solo actualizar si la tasa cambió (opcional, pero mostramos el cambio)
                if (tasaOficial !== tasa) {
                    tasaOficial = parseFloat(tasa);
                    
                    // Actualizar fecha
                    let fechaTexto = 'fecha no disponible';
                    if (data.fechaActualizacion) {
                        try {
                            const fecha = new Date(data.fechaActualizacion);
                            fechaTexto = fecha.toLocaleDateString('es-VE', {
                                year: 'numeric', month: 'long', day: 'numeric',
                                hour: '2-digit', minute: '2-digit'
                            });
                        } catch (e) {
                            fechaTexto = data.fechaActualizacion;
                        }
                    } else if (data.fecha) {
                        fechaTexto = data.fecha;
                    }
                    dolarFechaEl.textContent = fechaTexto.charAt(0).toUpperCase() + fechaTexto.slice(1);
                    
                    // Mostrar tasa
                    dolarValorEl.innerHTML = `${formatearVENumero(tasaOficial)} <small>Bs</small>`;
                    
                    // Actualizar calculadora
                    actualizarCamposCalculadora();

                    // Feedback sutil si fue manual
                    if (mostrarMensaje) {
                        mostrarNotificacion('Tasa actualizada ✓');
                    }
                } else if (mostrarMensaje) {
                    mostrarNotificacion('Tasa sin cambios');
                }

                // Reiniciar contador visual después de actualizar
                resetCountdown();
            })
            .catch(error => {
                console.error(error);
                if (mostrarMensaje) {
                    alert('Error al actualizar. Intenta de nuevo.');
                }
                dolarValorEl.innerHTML = 'error <small>—</small>';
                dolarFechaEl.innerHTML = 'Error de conexión';
            })
            .finally(() => {
                // Restaurar ícono
                if (autoRefreshIcon) autoRefreshIcon.className = 'fas fa-sync-alt';
            });
        }

        // ---- Notificación flotante sutil ----
        function mostrarNotificacion(mensaje) {
            // Crear un pequeño toast si no existe
            let toast = document.getElementById('toastNotification');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'toastNotification';
                toast.style.position = 'fixed';
                toast.style.bottom = '20px';
                toast.style.left = '50%';
                toast.style.transform = 'translateX(-50%)';
                toast.style.background = '#1f3a5f';
                toast.style.color = 'white';
                toast.style.padding = '8px 20px';
                toast.style.borderRadius = '40px';
                toast.style.fontSize = '0.9rem';
                toast.style.boxShadow = '0 5px 20px rgba(0,0,0,0.5)';
                toast.style.zIndex = '9999';
                toast.style.border = '1px solid #5f9eff';
                toast.style.backdropFilter = 'blur(5px)';
                document.body.appendChild(toast);
            }
            toast.textContent = mensaje;
            toast.style.opacity = '1';
            toast.style.transition = 'opacity 0.5s';
            
            setTimeout(() => {
                toast.style.opacity = '0';
            }, 2000);
        }

        // ---- Control de cuenta regresiva ----
        function resetCountdown() {
            countdownSeconds = 30;
            actualizarDisplayTiempo();
        }

        function actualizarDisplayTiempo() {
            if (timerDisplay) timerDisplay.textContent = countdownSeconds + 's';
            if (countdownTimer) countdownTimer.textContent = countdownSeconds + ' seg';
        }

        function iniciarAutoRefresh() {
            // Limpiar intervalos anteriores
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            if (countdownInterval) clearInterval(countdownInterval);

            // Intervalo de actualización cada 30 segundos
            autoRefreshInterval = setInterval(() => {
                obtenerDolar(false); // actualización silenciosa
            }, 30000); // 30,000 ms = 30 segundos

            // Intervalo de cuenta regresiva para feedback visual
            countdownInterval = setInterval(() => {
                countdownSeconds--;
                if (countdownSeconds <= 0) {
                    countdownSeconds = 30; // reiniciar al llegar a 0 (justo cuando se actualiza)
                }
                actualizarDisplayTiempo();
            }, 1000);
        }

        // ---- Función manual (llamada desde botón) ----
        function actualizarDolarManual() {
            obtenerDolar(true); // con mensaje
            resetCountdown();
        }

        // ---- Inicialización ----
        document.addEventListener('DOMContentLoaded', () => {
            // Formato inicial input
            inputUSD.value = formatearVENumero(1.00);
            
            // Obtener datos por primera vez
            obtenerDolar(false);
            
            // Iniciar actualización automática
            iniciarAutoRefresh();
        });

        // Exponer función manual al ámbito global
        window.actualizarDolarManual = actualizarDolarManual;
    </script>
</body>
</html>